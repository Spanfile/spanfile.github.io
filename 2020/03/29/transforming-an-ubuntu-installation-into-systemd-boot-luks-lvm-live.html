<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Transforming an Ubuntu installation into systemd-boot + XanMod + LUKS + LVM | Spans’ Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Transforming an Ubuntu installation into systemd-boot + XanMod + LUKS + LVM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My laptop’s been running standard Ubuntu 19.04 for some time now. I had the idea of swapping its bootloader, GRUB2, for systemd-boot, using the XanMod kernel and swapping its bunch-of-GPT-partitions into LUKS + LVM." />
<meta property="og:description" content="My laptop’s been running standard Ubuntu 19.04 for some time now. I had the idea of swapping its bootloader, GRUB2, for systemd-boot, using the XanMod kernel and swapping its bunch-of-GPT-partitions into LUKS + LVM." />
<link rel="canonical" href="https://blog.spans.fi/2020/03/29/transforming-an-ubuntu-installation-into-systemd-boot-luks-lvm-live.html" />
<meta property="og:url" content="https://blog.spans.fi/2020/03/29/transforming-an-ubuntu-installation-into-systemd-boot-luks-lvm-live.html" />
<meta property="og:site_name" content="Spans’ Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-29T14:48:47+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Transforming an Ubuntu installation into systemd-boot + XanMod + LUKS + LVM" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-03-29T14:48:47+00:00","datePublished":"2020-03-29T14:48:47+00:00","description":"My laptop’s been running standard Ubuntu 19.04 for some time now. I had the idea of swapping its bootloader, GRUB2, for systemd-boot, using the XanMod kernel and swapping its bunch-of-GPT-partitions into LUKS + LVM.","headline":"Transforming an Ubuntu installation into systemd-boot + XanMod + LUKS + LVM","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.spans.fi/2020/03/29/transforming-an-ubuntu-installation-into-systemd-boot-luks-lvm-live.html"},"url":"https://blog.spans.fi/2020/03/29/transforming-an-ubuntu-installation-into-systemd-boot-luks-lvm-live.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.spans.fi/feed.xml" title="Spans' Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Spans&#39; Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Transforming an Ubuntu installation into systemd-boot + XanMod + LUKS + LVM</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-03-29T14:48:47+00:00" itemprop="datePublished">Mar 29, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>My laptop’s been running standard Ubuntu 19.04 for some time now. I had the idea of swapping its bootloader, GRUB2, for systemd-boot, using the XanMod kernel and swapping its bunch-of-GPT-partitions into LUKS + LVM.</p>

<p>Motivation? I was bored as fuck during this self-imposed quarantine.</p>

<p>Quick word of warning, this post is in no way written to be a complete guide on how to achieve what I described step-by-step, but more of a writeup on what I did from which you can learn and adapt.</p>

<h2 id="starting-off">Starting off</h2>

<p>The initial partitions look as such:</p>

<table>
  <thead>
    <tr>
      <th>Partition</th>
      <th>Size</th>
      <th>Filesystem</th>
      <th>Mountpoint</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sda1</td>
      <td>250M</td>
      <td>EFI System</td>
      <td>/boot/efi</td>
    </tr>
    <tr>
      <td>sda2</td>
      <td>8G</td>
      <td>swap</td>
      <td>[SWAP]</td>
    </tr>
    <tr>
      <td>sda3</td>
      <td>560G</td>
      <td>ext4</td>
      <td>/home</td>
    </tr>
    <tr>
      <td>sda4</td>
      <td>50G</td>
      <td>ext4</td>
      <td>/var</td>
    </tr>
    <tr>
      <td>sda5</td>
      <td>380G</td>
      <td>ext4</td>
      <td>/</td>
    </tr>
  </tbody>
</table>

<p>Pretty standard stuff. What I’m aiming to achieve here is to get something like:</p>

<table>
  <thead>
    <tr>
      <th>Partition</th>
      <th>Size</th>
      <th>Filesystem</th>
      <th>Mountpoint</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sda1</td>
      <td>250M</td>
      <td>EFI System</td>
      <td>/boot/efi</td>
    </tr>
    <tr>
      <td>sda2</td>
      <td>~1TB</td>
      <td>LUKS</td>
      <td> </td>
    </tr>
    <tr>
      <td>-&gt; LVM</td>
      <td> </td>
      <td>LVM</td>
      <td> </td>
    </tr>
    <tr>
      <td>-&gt; -&gt; LV root</td>
      <td>60G</td>
      <td>ext4</td>
      <td>/</td>
    </tr>
    <tr>
      <td>-&gt; -&gt; LV</td>
      <td>60G</td>
      <td>ext4</td>
      <td>/var</td>
    </tr>
    <tr>
      <td>-&gt; &gt; LV home</td>
      <td>~800G</td>
      <td>ext4</td>
      <td>/home</td>
    </tr>
    <tr>
      <td>-&gt; -&gt; LV swap</td>
      <td>16G</td>
      <td>swap</td>
      <td>[SWAP]</td>
    </tr>
  </tbody>
</table>

<p>A bit more complicated, sure, but where’s fun in simple?</p>

<p>The two required packages for all this are <code class="language-plaintext highlighter-rouge">lvm2</code> and <code class="language-plaintext highlighter-rouge">cryptsetup</code>.</p>

<p>Let’s start off with the easy bit.</p>

<h2 id="systemd-boot">systemd-boot</h2>

<p>I’ll be closely following <a href="https://blobfolio.com/2018/06/replace-grub2-with-systemd-boot-on-ubuntu-18-04/">this guide by Josh Stoik</a>, adapted to my scenario.<br />
First up, change to the root user to ease things up a bit: <code class="language-plaintext highlighter-rouge">sudo -i</code></p>

<p>Create a skeleton directory structure for the new bootloader.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /boot/efi
mkdir -p loader/entries
mkdir ubuntu
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loader</code> and <code class="language-plaintext highlighter-rouge">entries</code> directories will contain configuration files for each thing you wish to boot, and the <code class="language-plaintext highlighter-rouge">ubuntu</code> directory will contain the kernel and initramfs images.</p>

<p>Then the initial loader configuration file. This defines the default boot, lets the boot selection screen be displayed for a second before automatically selecting the default, and allow the user to change the boot parameters before booting.</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">loader/loader.conf</code></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>default ubuntu
timeout 1
editor 1
</code></pre></div></div>

<p>‌<br />
As Stoik explains in his post, Debian-based systems won’t automatically get its generated kernel and initramfs images into this partition, which means you’ll have to do it yourself. Likewise, systemd-boot won’t generate entries for each kernel you might use so you’ll have to create those yourself as well. Stoik provides a script for it which I’ve adapted for my use.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
#
# This is a simple kernel hook to populate the systemd-boot entries
# whenever kernels are added or removed.
#
# Original script by Josh Stoik, modified by Spans
# 

# The UUID of your encrypted partition.
UUID="CHANGEME"

# The LUKS volume slug you want to use, which will result in the
# partition being mounted to /dev/mapper/CHANGEME.
VOLUME="CHANGEME"

# Any rootflags you wish to set.
ROOTFLAGS="quiet splash"

# Our kernels.
KERNELS=()
FIND="find /boot -maxdepth 1 -name 'vmlinuz-*' -type f -print0 | sort -rz"
while IFS= read -r -u3 -d $'\0' LINE; do
	KERNEL=$(basename "${LINE}")
	KERNELS+=("${KERNEL:8}")
done 3&lt; &lt;(eval "${FIND}")

# There has to be at least one kernel.
if [${#KERNELS[@]} -lt 1 ]; then
	echo -e "\e[2msystemd-boot\e[0m \e[1;31mNo kernels found.\e[0m"
	exit 1
fi

# Perform a nuclear clean to ensure everything is always in perfect
# sync.
rm /boot/efi/loader/entries/*.conf
rm -rf /boot/efi/ubuntu
mkdir /boot/efi/ubuntu

# Copy the latest kernel files to a consistent place so we can keep
# using the same loader configuration.
LATEST="${KERNELS[@]:0:1}"
echo -e "\e[2msystemd-boot\e[0m \e[1;32m${LATEST}\e[0m"
for FILE in config initrd.img System.map vmlinuz; do
    cp "/boot/${FILE}-${LATEST}" "/boot/efi/ubuntu/${FILE}"
    cat &lt;&lt; EOF &gt; /boot/efi/loader/entries/ubuntu.conf
title Ubuntu
linux /ubuntu/vmlinuz
initrd /ubuntu/initrd.img
options cryptdevice=UUID=${UUID}:${VOLUME} root=/dev/mapper/crypt--vg-root rw ${ROOTFLAGS}
EOF
done

# Copy any legacy kernels over too, but maintain their version-based
# names to avoid collisions.
if [${#KERNELS[@]} -gt 1 ]; then
	LEGACY=("${KERNELS[@]:1}")
	for VERSION in "${LEGACY[@]}"; do
	    echo -e "\e[2msystemd-boot\e[0m \e[1;32m${VERSION}\e[0m"
	    for FILE in config initrd.img System.map vmlinuz; do
	        cp "/boot/${FILE}-${VERSION}" "/boot/efi/ubuntu/${FILE}-${VERSION}"
	        cat &lt;&lt; EOF &gt; /boot/efi/loader/entries/ubuntu-${VERSION}.conf
title Ubuntu ${VERSION}
linux /ubuntu/vmlinuz-${VERSION}
initrd /ubuntu/initrd.img-${VERSION}
options cryptdevice=UUID=${UUID}:${VOLUME} root=/dev/mapper/crypt--vg-root rw ${ROOTFLAGS}
EOF
	    done
	done
fi

exit 0
</code></pre></div></div>

<p>This script will be used as a hook when kernel images are installed or updated. Copy it into both <code class="language-plaintext highlighter-rouge">/etc/kernel/postinst.d/zz-update-systemd-boot</code> and <code class="language-plaintext highlighter-rouge">/etc/kernel/postrm.d/zz-update-systemd-boot</code> and make them executable (permissions <code class="language-plaintext highlighter-rouge">0755</code>).</p>

<p>Then install the new bootloader: <code class="language-plaintext highlighter-rouge">bootctl install --path=/boot/efi</code></p>

<p>Stoik’s guide goes into configuring the bootloader for Secure Boot, but I’ll be skipping that for now. Test that the new bootloader works, and when it does you can safely purge GRUB: <code class="language-plaintext highlighter-rouge">apt purge grub*</code></p>

<h2 id="xanmod-kernel">XanMod kernel</h2>

<p>This bit’s simple. Add XanMod’s apt source and signing key.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 'deb http://deb.xanmod.org releases main' | sudo tee /etc/apt/sources.list.d/xanmod-kernel.list
wget -qO - https://dl.xanmod.org/gpg.key | sudo apt-key add -
</code></pre></div></div>

<p>Then install it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt update
apt install linux-xanmod
</code></pre></div></div>

<p>The kernel <code class="language-plaintext highlighter-rouge">postinst</code>- and <code class="language-plaintext highlighter-rouge">postrm</code>-hooks set up earlier will make sure the bootloader has the kernel and initramfs images available and that the proper bootloader entries are in place.</p>

<h2 id="pivoting-to-luks--lvm">Pivoting to LUKS + LVM</h2>

<p>This bit’s not simple. Since I’m so adventurous I decided to do all this without resorting to booting into a live media. On a high-level my approach is the following:</p>

<ol>
  <li>shrink the existing root partition enough to fit a copy of all data on the system</li>
  <li>set up the new partition and encryption scheme on the newly created empty space</li>
  <li>copy everything over to the new scheme</li>
  <li>make it bootable</li>
  <li>once it works, delete the old partitions</li>
  <li>grow the new partitions to fill the drive</li>
</ol>

<h3 id="get-the-old-root-unmounted">Get the old root unmounted</h3>

<p>Shrinking an ext4 partition can be done without reboots if the partition is first unmounted. Just directly unmounting the root partition isn’t going to work for obvious reasons, which is why it’s commonplace to use a bootable media and shrink the partition from there. I mentioned I wasn’t going to use any bootable media, so how exactly am I going to unmount my root partition while still booted from it?</p>

<p>Enter <code class="language-plaintext highlighter-rouge">pivot_root</code>, a thing about as magical as <code class="language-plaintext highlighter-rouge">chroot</code>. What it does is change the active root into some other location, just like <code class="language-plaintext highlighter-rouge">chroot</code>, but also mount the old root into a directory inside the new one. From there you can still mess with the old root while residing in the new one. I’ll be following and adapting <a href="https://unix.stackexchange.com/a/227318">this guide by Tom Hunt</a>.</p>

<p>First things first, there’s no way to do all the tricks here if there’s an entire desktop environment running. Start off by booting into single-user mode. With the bootloader we set up earlier, this is easily done by pressing <code class="language-plaintext highlighter-rouge">e</code> during the boot selection and appending <code class="language-plaintext highlighter-rouge">single</code> to the boot parameters. This’ll make systemd start the minimum required services and run an emergency rescue shell that lets you access everything you’ll need.</p>

<p>What we’ll be doing next is copying enough of the system into a memory-backed tmpfs, pivoting into it and unmounting the root filesystem on drive, after of which the drive’s partitions are free to mess around with.</p>

<p>Create a location for the pivot root and mount a tmpfs into it. Size the tmpfs appropriately to fit the important bits of your root partition. Keep in mind it’ll reside entirely in memory and use swap if needed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p /tmp/tmproot
cd /tmp
mount -t tmpfs -o size=14G none tmproot
</code></pre></div></div>

<p>Copy the important bits over to it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /tmp/tmproot/{proc,sys,dev,run,usr,var,tmp,oldroot}
cp -ax /{bin,etc,mnt,sbin,lib,lib64} tmproot/
cp -ax /usr/{bin,sbin,lib,lib64} tmproot/usr/
cp -ax /var/{account,empty,lib,local,lock,nis,opt,preserve,run,spool,tmp,yp} tmproot/var
</code></pre></div></div>

<p>I had an issue where the combined size of my root + <code class="language-plaintext highlighter-rouge">/var</code> was larger than I could fit into memory + swap (16G total), so I opted to leave <code class="language-plaintext highlighter-rouge">/var</code> out from the pivot. This turned out to not cause any issues - or in any case I didn’t notice or run into any.</p>

<p>Pivot into the new root and mount the system filesystems into it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount --make-rprivate /
pivot_root /tmp/tmproot /tmp/tmproot/oldroot
for i in dev proc sys run; do mount --move /oldroot/$i /$i; done
</code></pre></div></div>

<p>Now to get the old root partition unmounted. Everything running off it has to be stopped (or killed). See what’s using it and what services are currently running.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fuser -vm /oldroot systemctl | grep running
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">systemctl stop</code> the services, or kill the executables. Before you do anything there’s two catches though!</p>

<ul>
  <li>systemd itself is still running off the old root. This is easily fixed by re-execing it with systemctl daemon-reexec</li>
  <li>The rescue session you’re in is also running off the old root. Stopping or killing it will end the session and you’ll have to force-boot your machine to get back, nullifying all your progress. Instead of stopping or killing it, restart the session: <code class="language-plaintext highlighter-rouge">systemctl restart rescue</code></li>
</ul>

<p>Once the old root isn’t being used by anything anymore, unmount it: <code class="language-plaintext highlighter-rouge">umount /oldroot</code>. If like me you have <code class="language-plaintext highlighter-rouge">/var</code> and <code class="language-plaintext highlighter-rouge">/home</code> mounted on it, unmount them as well before finally unmounting the old root.<br />
‌</p>

<h3 id="shrink-it-crypt-it-lvm-it">Shrink it, crypt it, LVM it</h3>

<p>Now that the old root’s unmounted and we’re running off memory, the old root is easily shrunk.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>e2fsck -f /dev/sda5
resize2fs -L 30G /dev/sda5
</code></pre></div></div>

<p>This frees up a neat bit of space to work in. Using a decent partition editor (I’m using <code class="language-plaintext highlighter-rouge">fdisk</code>), delete the root partition and recreate it as large (or small?) as the filesystem was shrunk to. Then create a new partition in the empty space.</p>

<p>Encrypt and open this newly created partition (<em>pick a strong passphrase!</em>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cryptsetup luksFormat --type=luks2 /dev/sda6
cryptsetup open /dev/sda6 lvmcrypt
</code></pre></div></div>

<p>Set it up as an LVM physical volume, stick a volume group into it and get some logical volumes and filesystems going. Standard LVM stuff here, I won’t be going to much detail.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pvcreate /dev/mapper/lvmcrypt
vgcreate crypt-vg /dev/mapper/lvmcrypt

lvcreate -L 60G -n root crypt-vg
lvcreate -L 60G -n var crypt-vg
lvcreate -L 2G -n swap crypt-vg
lvcreate -l 100%FREE -n home crypt-vg

mkfs.ext4 /dev/mapper/crypt--vg-root
mkfs.ext4 /dev/mapper/crypt--vg-var
mkfs.ext4 /dev/mapper/crypt--vg-home
mkswap /dev/mapper/crypt--vg-swap
</code></pre></div></div>

<p>There’s the new partitions, now to get data from the old ones into them.</p>

<h3 id="the-great-migration">The great migration</h3>

<p>Get the old root back into business, and any other partitions mounted inside it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount /dev/sda5 /oldroot
mount /dev/sda4 /oldroot/var
mount /dev/sda3 /oldroot/home
</code></pre></div></div>

<p>Get the new partitions into play as well.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /newroot
mount /dev/mapper/crypt--vg-root /newroot
mkdir /newroot/{var,home}
mount /dev/mapper/crypt--vg-home /newroot/home
mount /dev/mapper/crypt--vg-var /newroot/var
</code></pre></div></div>

<p>Simple copies from there to here will do, much like how previously was done. This’ll take a while!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp -ax /oldroot/{bin,boot,sbin,etc,lib,lib64,libx32,opt,root,snap,srv,usr,var,home} /newroot/
</code></pre></div></div>

<p>Nothing better than stacking magic on top of magic; <code class="language-plaintext highlighter-rouge">chroot</code> into this new root.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in dev sys proc run; do mount --bind /$i /newroot/$i; done
chroot /newroot
</code></pre></div></div>

<p>We’ve now gone from the pre-existing root partition into an in-memory root into the new root. Pretty wild!</p>

<h3 id="boot-it">Boot it</h3>

<p>Now that there’s LUKS in between the drive and its data, there’s a bit of configuration for it in order to make it work at boot.</p>

<p>Find out the UUID of the encrypted partition: <code class="language-plaintext highlighter-rouge">blkid /dev/sda6</code>. Stick that and the crypt device’s name into <code class="language-plaintext highlighter-rouge">/etc/crypttab</code>.</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">/etc/crypttab</code></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># &lt;target name&gt;	&lt;source device&gt; &lt;key file&gt;	&lt;options&gt;
lvmcrypt UUID=CHANGEME none luks,discard
</code></pre></div></div>

<p>Jam the UUID into the script from earlier as well if you haven’t already!</p>

<p>Generate new initramfs and set up the bootloader.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update-initramfs -u -k all
/etc/kernel/postinst.d/zz-update-systemd-boot
</code></pre></div></div>

<p>The new root is now complete, including the bootloader and all. Cross your fingers and reboot the system.</p>

<h2 id="get-some-space">Get some space</h2>

<p>If all went well (somehow I doubt that) the system will boot into a prompt asking for the decryption key for the encrypted partition. Once that’s open, LVM steps in and activates the logical volumes inside the now-unlocked partition. From there on systemd does its thing and starts everything required.</p>

<p>There’s still the matter of reclaiming the space left behind by the old partitions.</p>

<h3 id="space-to-move-into">Space to move into</h3>

<p>Get rid of the old partitions and create a single new one to fill the space they left behind. Encrypt and open it. Create an LVM PV out of it. Extend the existing LVM VG with it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cryptsetup luksFormat --type=luks2 /dev/sda2
cryptsetup open /dev/sda2 newcrypt
lvcreate /dev/mapper/newcrypt
vgextend crypt-vg /dev/mapper/newcrypt
</code></pre></div></div>

<p>Move the entire previous PV into the new one. This too will take a while!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pvmove /dev/mapper/crypt /dev/mapper/newcrypt
</code></pre></div></div>

<p>Remove the old PV from the VG. Close and delete it. Expand the new one to fill its space.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vgreduce crypt-vg /dev/mapper/lvmcrypt
cryptsetup close /dev/mapper/lvmcrypt
fdisk /dev/sda
...
</code></pre></div></div>

<p>Extend the partition, the crypt device and the PV to this new space.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fdisk /dev/sda
...
cryptsetup resize /dev/mapper/newcrypt
pvextend /dev/mapper/newcrypt
</code></pre></div></div>

<h3 id="bootings-broke-fix-it">Booting’s broke, fix it</h3>

<p>This new partition has a different UUID to the previous one (duh), change it in both <code class="language-plaintext highlighter-rouge">/etc/crypttab</code> and the systemd-boot hook scripts.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>blkid /dev/sda2
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">/etc/crypttab</code></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># &lt;target name&gt;	&lt;source device&gt; &lt;key file&gt;	&lt;options&gt;
lvmcrypt UUID=NEWUUID none luks,discard
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">/etc/kernel/postinst.d/zz-update-systemd-boot</code> <code class="language-plaintext highlighter-rouge">/etc/kernel/postrm.d/zz-update-systemd-boot</code></p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
# The UUID of your encrypted partition.
UUID="NEWUUID"
...
</code></pre></div></div>

<p>Recreate initramfs and set up the bootloader</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update-initramfs -u -k all
/etc/kernel/postinst.d/zz-update-systemd-boot
</code></pre></div></div>

<p>That’s it! Enjoy your new encrypted, LVM’d, systemd-boot’d and XanMod’d Ubuntu.</p>

<!--kg-card-end: markdown-->

  </div><a class="u-url" href="/2020/03/29/transforming-an-ubuntu-installation-into-systemd-boot-luks-lvm-live.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Spans&#39; Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Spans&#39; Blog</li><li><a class="u-email" href="mailto:me@spans.fi">me@spans.fi</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/spanfile"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">spanfile</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
